# State Persistence

1. Persistence Volumes
2. Persistence Volume claims

## Volumes

Let's look at volumes in the docker containers. The volumes in docker containers are meant to be only short period of time, only until the container is live. The data is destroyed along with the container. To persist the data present in the container, we attach a volume to the folder in the container. Even if the continer deleted the data generated still exists. 

Same applies for kubernetes

We attach a volume for the data generated by the pod. Even after the pod is deleted, the data remains. 

[Volume Simple Implementation](simple-pod-definition.yaml)

In the above example we have defined hostpath option to configure a directory on the host as storage space for the volume. Now that works fine in a single node. However it is not recommended to use in a multi node cluster.

**Reason**:
The pods would use `/data` directory on all the nodes and expect all of them to be the same and have the same data. Since, there are on different servers, they are infact not the same. 

## Persistent Volumes

When we created volumes in the previously, we configured volumes along with pod definition file. So every configuration information required to configure the storage for the volume is present in the pod definition file.

Now, when you have large environment with lot of users deploying a lot of pods, the users would have to configure storage everytime, for each pod. 

Instead, you would like to manage storage more centrally. You would like it be configured in such a way that admin can create a large pool of storage and then have users carve out pieces from it, as required. That is where persistence volumes can help us. 

A persistence volume is a cluster wide pool of storage volumes, configured by an admin to be used by users. The users now select stoarge from this pool using persistance volume claims. 

[Simple Persistance Voluem](simple-pv-definition.yaml)

## Persistence Volume Claims

* To make the storage available to a node
* PV and PVC are two separate objects in kuberentes namespace 
* An admin creates a set of PV's and user creates PVC's to use the storage
* Once the PVC's are created, kuberentes binds the volumes to claims based on the request based on the properties set on the volume. 
* Every persistence Volume claim is bound to single persistent volume
* There are multiple criterias that would be checked to map the PV's to PVC's 
* Like the memory required, read write access
* If there are multiple PV's eligible, then you can use labels to map to a particular PV
* There is **One to One** mapping between PV and PVC

[PVC definition](pvc-definition.yaml)

and the corresponding PV is as below

[PV Definition](pv-definition.yaml)

### Deleting the PVC

You an delete the PVC with a simple `kubectl` command

```bash
kubectl delete persistencevolumeclaim myclaim
```

This would delete the PVC. But what happens to the mapping PV?

There is property for PV called `persistenceVolumeReclaimPolicy`, which would be set to `Retain` be default. Which mean the PV still exists until it is manually deleted. It is not available for reuse by any other claims. 

The other value is `Delete`, which would delete PV, after the deletion of PVC. 

The last option would be `Recycle`, The data in the data volume will be scrubbed for making it available to other claims. 
